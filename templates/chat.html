{% extends 'base.html' %}

{% block content %}
<div class="h-[calc(100vh-140px)] flex flex-col glass-panel rounded-2xl overflow-hidden mt-4">
    <!-- Chat Header -->
    <div class="p-4 border-b border-white/10 bg-white/5 flex items-center gap-4">
        <a href="{% url 'profile_view' other_user.username %}"
            class="flex items-center gap-3 hover:opacity-80 transition-opacity">
            <div
                class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-purple-500 flex items-center justify-center font-bold">
                {{ other_user.username|make_list|first|upper }}
            </div>
            <div>
                <h3 class="font-bold">{{ other_user.username }}</h3>
                <span class="text-xs text-green-400 flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-green-400"></span> Online
                </span>
            </div>
        </a>
        <div
            class="ml-auto px-3 py-1 rounded-full bg-green-500/10 border border-green-500/20 text-green-200 text-xs flex items-center gap-2">
            <span class="material-symbols-outlined text-[14px]">history</span>
            History enabled
        </div>
    </div>

    <!-- Messages Area -->
    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-hide">
        {% for msg in messages %}
        <div class="flex w-full {% if msg.sender == request.user %}justify-end{% else %}justify-start{% endif %}"
            id="msg-{{ msg.id }}">
            <div
                class="max-w-[70%] px-4 py-2 rounded-2xl {% if msg.sender == request.user %}bg-primary text-white rounded-tr-none{% else %}bg-white/10 text-white rounded-tl-none{% endif %}">
                <p>{{ msg.content }}</p>
                <span class="text-[10px] opacity-50 block text-right mt-1">{{ msg.timestamp|date:"M d, H:i" }}</span>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Input Area -->
    <div class="p-4 border-t border-white/10 bg-[#101622]">
        <form id="chat-form" class="flex gap-2">
            <input type="text" id="message-input" placeholder="Type a message..."
                class="flex-1 bg-white/5 border border-white/10 rounded-full px-4 py-3 focus:outline-none focus:ring-1 focus:ring-primary text-white placeholder-white/30"
                autocomplete="off">
            <button type="submit"
                class="w-12 h-12 rounded-full bg-primary flex items-center justify-center hover:bg-blue-600 transition-colors">
                <span class="material-symbols-outlined">send</span>
            </button>
        </form>
    </div>
</div>

<script>
    const chatContainer = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    // Fix: Use correct Django template syntax and handle empty list safely
    let lastMessageId = {{ last_id }};
    const otherUsername = "{{ other_user.username }}";

    // Scroll to bottom initially
    chatContainer.scrollTop = chatContainer.scrollHeight;

    // Send Message
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const content = messageInput.value.trim();
        if (!content) return;

        // Optimistic UI update
        const tempId = 'temp-' + Date.now();
        const msgDiv = document.createElement('div');
        msgDiv.className = `flex w-full justify-end`;
        msgDiv.id = tempId;

        // Get current time formatted nicely (approximate)
        const now = new Date();
        const timeString = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ', ' +
            now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });

        msgDiv.innerHTML = `
            <div class="max-w-[70%] px-4 py-2 rounded-2xl bg-primary text-white rounded-tr-none">
                <p>${content}</p>
                <span class="text-[10px] opacity-50 block text-right mt-1">${timeString}</span>
            </div>
        `;
        chatContainer.appendChild(msgDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        messageInput.value = '';

        try {
            const response = await fetch('/api/send/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}' // Django CSRF
                },
                body: JSON.stringify({
                    receiver: otherUsername,
                    content: content
                })
            });
            const data = await response.json();
            if (data.status === 'success') {
                // Update the temp ID to real ID to avoid duplicates from poller
                const element = document.getElementById(tempId);
                if (element) {
                    element.id = 'msg-' + data.id;
                    lastMessageId = data.id; // Update lastMessageId so polling knows
                }
            } else {
                // Handle error (simple alert for now)
                alert('Failed to send message: ' + data.message);
                document.getElementById(tempId)?.remove();
            }
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Error sending message. Please check connection.');
            document.getElementById(tempId)?.remove();
        }
    });

    // Poll for new messages
    async function pollMessages() {
        try {
            const response = await fetch(`/api/messages/${otherUsername}/?last_id=${lastMessageId}`);
            const data = await response.json();

            if (data.messages && data.messages.length > 0) {
                let shouldScroll = chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight - 50;

                data.messages.forEach(msg => {
                    // Avoid duplicates if any
                    if (document.getElementById(`msg-${msg.id}`)) return;

                    lastMessageId = msg.id;
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `flex w-full ${msg.is_me ? 'justify-end' : 'justify-start'}`;
                    msgDiv.id = `msg-${msg.id}`;

                    msgDiv.innerHTML = `
                        <div class="max-w-[70%] px-4 py-2 rounded-2xl ${msg.is_me ? 'bg-primary text-white rounded-tr-none' : 'bg-white/10 text-white rounded-tl-none'}">
                            <p>${msg.content}</p>
                            <span class="text-[10px] opacity-50 block text-right mt-1">${msg.timestamp}</span>
                        </div>
                    `;
                    chatContainer.appendChild(msgDiv);
                });

                // Auto scroll if was at bottom or if it's my message
                if (shouldScroll) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }
        } catch (error) {
            console.error('Polling error:', error);
        }
    }

    // Poll every 2 seconds
    setInterval(pollMessages, 2000);
</script>
{% endblock %}